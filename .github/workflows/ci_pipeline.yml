name: CI - IrviQuiz

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  IMAGE_API: irvids/irviquiz-api
  IMAGE_WEB: irvids/irviquiz-web

jobs:
  build-test-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v3

    - name: (Simulado) Rodar testes e lint
      run: |
        echo "âœ… Rodando lint e testes simulados..."
        echo "âœ… Testes fictÃ­cios passaram com sucesso!"

    - name: Gerar TAG automÃ¡tica
      run: echo "TAG=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

    - name: Login no Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Build e push do backend
      run: |
        docker build -t $IMAGE_API:$TAG -t $IMAGE_API:latest ./IrviQuiz.API
        docker push $IMAGE_API:$TAG
        docker push $IMAGE_API:latest

    - name: Build e push do frontend
      run: |
        docker build -t $IMAGE_WEB:$TAG -t $IMAGE_WEB:latest ./IrviQuiz.Web
        docker push $IMAGE_WEB:$TAG
        docker push $IMAGE_WEB:latest

    - name: Criar release no GitHub
      uses: softprops/action-gh-release@v1
      with:
        tag_name: $TAG
        name: "Release $TAG"
        body: |
          ðŸš€ Nova versÃ£o do IrviQuiz gerada automaticamente.
          ðŸ”§ Backend: $IMAGE_API:$TAG
          ðŸŽ¨ Frontend: $IMAGE_WEB:$TAG
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ env.TAG }}
        IMAGE_API: ${{ env.IMAGE_API }}
        IMAGE_WEB: ${{ env.IMAGE_WEB }}
